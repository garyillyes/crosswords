<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Market Crossword</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cell-input {
            caret-color: transparent;
        }

        .cell-input:focus {
            background-color: #bfdbfe;
        }

        .highlight-word {
            background-color: #fef08a !important;
        }

        /* Hide numbers inside the input */
        .clue-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 0.6rem;
            line-height: 1;
            pointer-events: none;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col items-center py-8">

    <header class="mb-6 text-center">
        <h1 class="text-4xl font-black tracking-tight text-slate-900">NEWS CROSSWORD</h1>
        <p class="text-sm text-slate-500 mt-2" id="date-display">Loading today's puzzle...</p>
    </header>

    <div class="flex flex-col lg:flex-row gap-8 max-w-6xl w-full px-4">

        <!-- Grid Container -->
        <div class="flex-1 flex justify-center">
            <div id="grid-container" class="bg-black p-1 shadow-2xl rounded-sm border-4 border-slate-900 relative">
                <!-- Grid Injected Here -->
            </div>
        </div>

        <!-- Clues Container -->
        <div class="w-full lg:w-1/3 flex flex-col gap-4 h-[600px]">
            <div class="bg-white p-4 rounded-lg shadow border border-slate-200 flex-1 overflow-y-auto">
                <h2 class="font-bold text-xl mb-3 border-b pb-2">Across</h2>
                <ul id="clues-across" class="space-y-2 text-sm"></ul>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-slate-200 flex-1 overflow-y-auto">
                <h2 class="font-bold text-xl mb-3 border-b pb-2">Down</h2>
                <ul id="clues-down" class="space-y-2 text-sm"></ul>
            </div>
        </div>
    </div>

    <script>
        let currentPuzzle = null;
        let gridState = {}; // "x,y": "CHAR"

        async function loadPuzzle() {
            try {
                // In a real repo, this path works because index.html is in docs/
                // and data is in docs/data/
                const response = await fetch('./data/puzzle.json');
                if (!response.ok) throw new Error("Puzzle not found");
                currentPuzzle = await response.json();
                initGame(currentPuzzle);
            } catch (e) {
                document.getElementById('date-display').innerText = "Error loading puzzle: " + e.message;
            }
        }

        function initGame(data) {
            document.getElementById('date-display').innerText = data.title;
            const container = document.getElementById('grid-container');

            // Set grid dimensions
            const cellSize = 40; // px
            container.style.display = 'grid';
            container.style.gridTemplateColumns = `repeat(${data.width}, ${cellSize}px)`;
            container.style.gridTemplateRows = `repeat(${data.height}, ${cellSize}px)`;
            container.style.gap = '1px';

            // Initialize Grid State Map
            const cellMap = new Map(); // "x,y" -> cellData

            // Populate cells based on word paths
            data.words.forEach((wordObj, index) => {
                let x = wordObj.startX;
                let y = wordObj.startY;

                // Add clue to list
                addClueToList(wordObj, index + 1);

                for (let i = 0; i < wordObj.word.length; i++) {
                    const key = `${x},${y}`;

                    if (!cellMap.has(key)) {
                        cellMap.set(key, {
                            x, y,
                            char: wordObj.word[i],
                            number: (i === 0) ? (index + 1) : null // Basic numbering logic
                        });
                    } else {
                        // Intersection, handle numbering priority if needed
                        if (i === 0) cellMap.get(key).number = index + 1;
                    }

                    if (wordObj.direction === 'horizontal') x++;
                    else y++;
                }
            });

            // Render Cells
            for (let y = 0; y < data.height; y++) {
                for (let x = 0; x < data.width; x++) {
                    const key = `${x},${y}`;
                    const cellData = cellMap.get(key);

                    const div = document.createElement('div');
                    div.className = "relative w-full h-full bg-slate-900"; // Black by default (block)

                    if (cellData) {
                        div.className = "relative w-full h-full bg-white";

                        if (cellData.number) {
                            const span = document.createElement('span');
                            span.className = "clue-number";
                            span.innerText = cellData.number;
                            div.appendChild(span);
                        }

                        const input = document.createElement('input');
                        input.className = "cell-input w-full h-full text-center font-bold uppercase text-lg outline-none bg-transparent cursor-pointer";
                        input.maxLength = 1;
                        input.dataset.x = x;
                        input.dataset.y = y;
                        input.dataset.answer = cellData.char;

                        // Interaction
                        input.addEventListener('input', (e) => handleInput(e, x, y, data));
                        input.addEventListener('keydown', (e) => handleKey(e, x, y));
                        input.addEventListener('focus', (e) => highlightClue(x, y));

                        div.appendChild(input);
                    }
                    container.appendChild(div);
                }
            }
        }

        function addClueToList(wordObj, num) {
            const li = document.createElement('li');
            li.innerHTML = `<span class="font-bold text-blue-600">${num}.</span> ${wordObj.clue}`;
            li.dataset.wordIndex = num;
            li.className = "cursor-pointer hover:bg-blue-50 p-1 rounded transition-colors";
            li.addEventListener('click', () => highlightWordOnGrid(wordObj));

            if (wordObj.direction === 'horizontal') {
                document.getElementById('clues-across').appendChild(li);
            } else {
                document.getElementById('clues-down').appendChild(li);
            }
        }

        function handleInput(e, x, y, data) {
            const val = e.target.value.toUpperCase();
            e.target.value = val;

            // Verify (Basic Check)
            if (val === e.target.dataset.answer) {
                e.target.classList.add('text-green-600');
            } else {
                e.target.classList.remove('text-green-600');
            }

            // Auto-advance logic could be added here, 
            // but requires tracking current direction context
        }

        function handleKey(e, x, y) {
            // Arrow key navigation logic would go here
        }

        function highlightClue(x, y) {
            // Logic to highlight the relevant list item in the side panel
        }

        function highlightWordOnGrid(wordObj) {
            // Clear previous highlights
            document.querySelectorAll('.cell-input').forEach(el => el.classList.remove('highlight-word'));

            let x = wordObj.startX;
            let y = wordObj.startY;

            for (let i = 0; i < wordObj.length; i++) {
                const input = document.querySelector(`.cell-input[data-x="${x}"][data-y="${y}"]`);
                if (input) input.classList.add('highlight-word');

                if (wordObj.direction === 'horizontal') x++;
                else y++;
            }
        }

        loadPuzzle();
    </script>
</body>

</html>